node {
 
    def maven = tool 'mavenjenkins'
         
    def gitcommit
    stage('VerificaciÃ³n SCM') {
      checkout scm
      sh "git rev-parse --short HEAD > .git/commit-id"                        
      gitcommit = readFile('.git/commit-id').trim()
    }
    
    stage('Build') {
      sh 'mvn -B -DskipTests clean package'
    }
    
    stage('Test') {
      sh 'mvn test'
      post {
        always {
          junit 'target/surefire-reports/*.xml'
        }
      }
    }
    
    stage('Docker Build & Push') {
      docker.withRegistry('https://registry.hub.docker.com', 'docker') {
        def appmavenjenkins = docker.build("macloujulian/mavenjenkins:${gitcommit}", ".")
        appmavenjenkins.push()
      }
    }
}
